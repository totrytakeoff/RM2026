# OpenOCD配置文件 - 用于STM32F407IGHx
# 适配DAP-Link调试器

# 指定调试器接口
adapter driver cmsis-dap

# 指定目标芯片
set CHIPNAME stm32f4x
set CPUTAPID 0x4ba00477
set WORKAREASIZE 0x10000

# 设置芯片配置
source [find target/stm32f4x.cfg]
# OpenOCD会自动在其根目录的share/openocd/scripts/target里面寻找对应的配置文件

# 在调试时冻结看门狗，防止看门狗复位
# 这将在调试器连接时自动冻结WWDG和IWDG
$_TARGETNAME configure -event gdb-attach {
    # 冻结看门狗，防止在调试时触发看门狗复位
    stm32f4x.wwdg 0
    stm32f4x.iwdg 0
}

# 设置时钟速度
adapter speed 2000

# 启用SRAM工作区
$_TARGETNAME configure -work-area-phys 0x20000000 -work-area-size $WORKAREASIZE -work-area-backup 0

# 初始化和复位配置
$_TARGETNAME configure -event reset-init {
    # 设置时钟
    mww 0x40023830 0x00000000
    mww 0x40023830 0x00000001
    mww 0x40023830 0x00000003
}

# 启用调试
$_TARGETNAME configure -event gdb-attach {
    halt
}