; PlatformIO Project Configuration File for Robomaster C Board (STM32F407IGT6)
;
;   Build options: build flags, source filter
;   Upload options: custom upload port, speed and extra flags
;   Library options: dependencies, extra library storages
;   Advanced options: extra scripting
;
; Please visit documentation for the other options and examples
; https://docs.platformio.org/page/projectconf.html

; =============================================================================
; 默认环境配置 - dfu
; =============================================================================
[platformio]
default_envs = dfu


[env:dfu]
; 平台选择: ststm32 - STMicroelectronics STM32系列微控制器平台
platform = ststm32
; 开发板型号: genericSTM32F407IGT6 - 通用STM32F407IGT6开发板
board = genericSTM32F407IGT6
; 框架选择: stm32cube - STM32Cube HAL库框架
framework = stm32cube

; 编译标志配置 - 优化和处理器特定设置
build_flags =
    ; 定义STM32F407系列芯片，用于HAL库的条件编译
    -DSTM32F407xx
    ; 启用HAL驱动库，提供硬件抽象层接口
    -DUSE_HAL_DRIVER
    ; 编译优化级别2，平衡性能和稳定性
    -O2
    ; 指定目标CPU为Cortex-M4内核
    -mcpu=cortex-m4
    ; 指定FPU单元为FPv4-SP-D16(单精度浮点运算单元)
    -mfpu=fpv4-sp-d16
    ; 浮点ABI为硬件浮点，使用FPU进行浮点运算
    -mfloat-abi=hard
    ; 强制使用VFP寄存器参数传递

    ; 添加头文件搜索路径
    ; -I lib/C_board_bsp/inc
    ; 避免传递不可识别的 ld 选项，保留编译器浮点设置
    -Wl,--no-warn-mismatch

; 上传协议配置 - DFU (Device Firmware Update)
upload_protocol = dfu
; 上传速度设置 - DFU上传波特率
upload_speed = 115200
; DFU 上传标志 - 指定设备 VID:PID 和内部 Flash alt 值  
upload_flags = 
    -d 0483:df11
    -a 0

; 自定义上传命令 - 使用专用脚本绕过 PlatformIO 的错误 DFU suffix
upload_command = ./upload_dfu.sh $BUILD_DIR

; 注释掉BSP库依赖，改为直接包含源文件
; lib_ldf_mode = deep
; lib_deps = file://lib/C_Board_BSP


; =============================================================================
; ST-Link上传方式配置 (通过ST-Link调试器上传)
; =============================================================================
[env:stlink]
; 平台选择: ststm32 - STMicroelectronics STM32系列微控制器平台
platform = ststm32
; 开发板型号: genericSTM32F407IGT6 - 通用STM32F407IGT6开发板
board = genericSTM32F407IGT6
; 框架选择: stm32cube - STM32Cube HAL库框架
framework = stm32cube

; 编译标志配置 - 与DFU环境相同的编译设置
build_flags =
    ; 定义STM32F407系列芯片，用于HAL库的条件编译
    -DSTM32F407xx
    ; 启用HAL驱动库，提供硬件抽象层接口
    -DUSE_HAL_DRIVER
    ; 编译优化级别2，平衡性能和稳定性
    -O2
    ; 指定目标CPU为Cortex-M4内核
    -mcpu=cortex-m4
    ; 指定FPU单元为FPv4-SP-D16(单精度浮点运算单元)
    -mfpu=fpv4-sp-d16
    ; 浮点ABI为硬件浮点，使用FPU进行浮点运算
    -mfloat-abi=hard
    ; 添加头文件搜索路径
    -I lib/C_Board_BSP/include
    ; 强制使用VFP指令
    -u__printf_float
    -u__scanf_float
 
    -Wl,--no-warn-mismatch

; 上传协议配置 - ST-Link (STMicroelectronics调试器)
upload_protocol = stlink
; 监控过滤器 - 只显示错误和警告信息
monitor_filters = esp32_exception_decoder
; 注释掉BSP库依赖，改为直接包含源文件
; lib_ldf_mode = deep
; lib_deps = file://lib/C_Board_BSP

; =============================================================================
; 调试配置选项
; =============================================================================
; 调试工具配置 - 支持ST-Link和J-Link
debug_tool = stlink
; 调试服务器类型
debug_server = 
    stlink
    /usr/local/bin/st-util
    -p 3333
; 调试初始化命令
debug_init_cmds = 
    target remote localhost:3333
    monitor reset halt
    load
    monitor reset init

; =============================================================================
; 库依赖配置
; =============================================================================
; 如果需要额外的库，可以在这里添加
; lib_deps = 
;     adafruit/Adafruit GFX Library@^1.10.7
;     adafruit/Adafruit SSD1306@^2.5.7

; =============================================================================
; 高级配置选项
; =============================================================================
; 构建类型 - release (发布版本) 或 debug (调试版本)
build_type = release
; 清理构建目录
; clean_cmd = rm -rf .pio/build
; 并行编译任务数
build_jobs = 4

; =============================================================================
; 使用说明
; =============================================================================
; DFU上传方式使用方法:
; 1. 将开发板设置为DFU模式 (通常通过BOOT0+BOOT1引脚设置)
; 2. 运行: pio run -t upload -e dfu
;
; ST-Link上传方式使用方法:
; 1. 连接ST-Link调试器到开发板
; 2. 运行: pio run -t upload -e stlink
;
; 默认环境设置 (可选):
; 如果想设置默认环境，可以取消下面的注释
; [platformio]
; default_envs = dfu
