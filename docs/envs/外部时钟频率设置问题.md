
# 📝 STM32 时钟配置与串口乱码问题总结

## 📌 问题描述

在 STM32 项目中，使用 **PlatformIO (PIO)** 工具链，发现在使用官方 Demo 提供的 `SystemClock_Config` 函数（基于 HSE/PLL 的高速配置）时，串口接收到的是乱码。但将时钟配置切换为 `SystemClock_Config_HSI` 函数（基于 HSI 的低速配置）后，串口通信恢复正常。

**硬件推测：** 晶振丝印为 `T120`，推测外部晶振频率为  **12MHz** 。

## ⚙️ 故障代码分析 (SystemClock_Config)

官方 Demo 中的 PLL 配置如下：

* **PLLM (分频系数):** **$6$**
* **PLLN (倍频系数):** **$168$**
* **PLLP (主时钟分频):** **$\text{DIV2}$** (即 **$/2$**)

计算公式：

$$
\text{SYSCLK} = \frac{\text{HSE}}{\text{PLLM}} \times \text{PLLN} \div \text{PLLP}
$$

理论计算 (基于 12MHz 晶振):

$$
\text{SYSCLK} = \frac{12\text{MHz}}{6} \times 168 \div 2 = 2\text{MHz} \times 84 = \mathbf{168\text{MHz}}
$$

**结论：** 从硬件配置上看，该代码配置是**正确**的，目标是使系统主频达到 F4 系列的最高速度 168MHz。

## 💡 根本原因：宏定义与工具链的冲突

乱码的根本原因在于  **串口波特率计算错误** 。虽然 CPU 实际运行时钟是正确的 (168MHz)，但 HAL 库在计算 UART 分频系数时，依赖的 **`HSE_VALUE`** 宏定义与实际硬件不符。

### 1. 软件和硬件的预期不一致

| **参数**         | **硬件实际情况**                                    | **官方 Demo (或 PIO 默认宏定义) 的预期**                  |
| ---------------------- | --------------------------------------------------------- | --------------------------------------------------------------- |
| **外部晶振频率** | **12,000,000 Hz (12MHz)**                           | **8,000,000 Hz 或 25,000,000 Hz**                         |
| **系统主频计算** | **$12\text{M} / 6 \times \dots = 168\text{MHz}$** | **$25\text{M} / 6 \times \dots \approx 350\text{MHz}$** |

### 2. 乱码产生过程

1. HAL 库在初始化 UART 时，查找编译时的宏定义 `HSE_VALUE` (假设它默认为 25MHz)。
2. HAL 库用 **25MHz** 作为输入，代入 PLL 公式计算出理论主频为  **350MHz** 。
3. HAL 库根据这个错误的 350MHz，去计算 115200 波特率所需的分频系数，并写入 UART 寄存器。
4. **实际情况：** CPU 实际运行在  **168MHz** 。
5. **结果：** 168MHz 的时钟去驱动一个为 350MHz 计算出来的分频系数，导致实际波特率偏差巨大，从而产生乱码。

### 3. HSI 成功的原因

`SystemClock_Config_HSI` 函数将系统主频设置为芯片内部固定的  **16MHz** 。由于 HSI 频率固定且不需要复杂的 PLL 计算，HAL 库对 HSI 的计算通常不会出错，因此波特率计算正确，通信正常。

## ✅ 最终解决方案 (PlatformIO)

解决此问题的最佳方法是在 PlatformIO 的配置文件中，强制定义正确的晶振频率，使其全局生效。

1. **打开项目根目录下的 `platformio.ini` 文件。**
2. **在环境配置（`[env:...]`）中，添加或修改 `build_flags`：**
   **Ini, TOML**

   ```
   ; ... 其他配置 ...
   build_flags = 
       -D HSE_VALUE=12000000 
   ```
3. **重建项目 (Clean and Build/Upload)。**

   * 在 PIO 侧边栏点击  **"Clean"** ，然后重新编译下载，确保所有驱动文件都使用新的宏定义进行编译。

**注意：** **不建议**直接修改 `system_stm32f4xx.c` 文件，因为它属于框架文件，更新时修改可能丢失。

---

### 📘 总结结论

串口乱码不是因为时钟配置代码本身有错，而是因为 **工程环境（PlatformIO）的宏定义默认值**与 **实际硬件（12MHz 晶振）** 不匹配，导致 HAL 库计算 UART 波特率时发生了严重的数学错误。通过修改 `platformio.ini` 文件来修正 `HSE_VALUE` 宏定义即可解决问题。
