; PlatformIO Project Configuration File for Robomaster C Board (STM32F407IGT6)
;
;   Build options: build flags, source filter
;   Upload options: custom upload port, speed and extra flags
;   Library options: dependencies, extra library storages
;   Advanced options: extra scripting
;
; Please visit documentation for the other options and examples
; https://docs.platformio.org/page/projectconf.html

; =============================================================================
; 默认环境配置 - cmsis-dap-native
; =============================================================================
[platformio]
default_envs = cmsis-dap-native


[env:dfu]
; 平台选择: ststm32 - STMicroelectronics STM32系列微控制器平台
platform = ststm32
; 开发板型号: genericSTM32F407IGT6 - 通用STM32F407IGT6开发板
board = genericSTM32F407IGT6
; 框架选择: stm32cube - STM32Cube HAL库框架
framework = stm32cube

; 编译标志配置 - 优化和处理器特定设置
build_flags =
    ; 定义STM32F407系列芯片，用于HAL库的条件编译
    -DSTM32F407xx
    ; 启用HAL驱动库，提供硬件抽象层接口
    -DUSE_HAL_DRIVER
    ; 编译优化级别2，平衡性能和稳定性
    -O2
    ; 指定目标CPU为Cortex-M4内核
    -mcpu=cortex-m4
    ; 指定FPU单元为FPv4-SP-D16(单精度浮点运算单元)
    -mfpu=fpv4-sp-d16
    ; 浮点ABI为硬件浮点，使用FPU进行浮点运算
    -mfloat-abi=hard
    ; 强制使用VFP寄存器参数传递

    ; 添加头文件搜索路径
    -I include
    -I src/hal
    -I src/bsp
    -I src/drivers
    -I src/common
    ; 避免传递不可识别的 ld 选项，保留编译器浮点设置
    -Wl,--no-warn-mismatch

; 仅编译 C++ 入口，排除 C 入口 main.c，避免同名目标冲突（使用 build_src_filter）
build_src_filter =
    +<*>
    -<main.cpp>
    -<test/*>
    +<test/bsp_board_demo.cpp>
    

; 上传协议配置 - DFU (Device Firmware Update)
upload_protocol = dfu
; 上传速度设置 - DFU上传波特率
upload_speed = 115200
; DFU 上传标志 - 指定设备 VID:PID 和内部 Flash alt 值  
upload_flags = 
    -d 0483:df11
    -a 0

; 自定义上传命令 - 使用专用脚本绕过 PlatformIO 的错误 DFU suffix
upload_command = ./scripts/upload_dfu.sh $BUILD_DIR

; =============================================================================
; 原生CMSIS-DAP上传方式配置 (不使用OpenOCD)
; =============================================================================
[env:cmsis-dap-native]
; 平台选择: ststm32 - STMicroelectronics STM32系列微控制器平台
platform = ststm32
; 开发板型号: genericSTM32F407IGT6 - 通用STM32F407IGT6开发板
board = genericSTM32F407IGT6
; 框架选择: stm32cube - STM32Cube HAL库框架
framework = stm32cube

; 编译标志配置 - 与DFU环境相同的编译设置
build_flags =
    ; 定义STM32F407系列芯片，用于HAL库的条件编译
    -DSTM32F407xx
    ; 启用HAL驱动库，提供硬件抽象层接口
    -DUSE_HAL_DRIVER
    ; 编译优化级别2，平衡性能和稳定性
    -O2
    ; 指定目标CPU为Cortex-M4内核
    -mcpu=cortex-m4
    ; 指定FPU单元为FPv4-SP-D16(单精度浮点运算单元)
    -mfpu=fpv4-sp-d16
    ; 浮点ABI为硬件浮点，使用FPU进行浮点运算
    -mfloat-abi=hard
    ; 添加头文件搜索路径
    -I include
    -I src/hal
    -I src/bsp
    -I src/drivers/*
    -I src/common/*
    ; 强制使用VFP指令
    -u__printf_float
    -u__scanf_float

    -Wl,--no-warn-mismatch

build_src_filter =
    +<*>
    -<main.cpp>
    -<test/*>
    ; -<bsp/*>
    +<hal/*>
    +<drivers/*>
    +<common/*>
    ; +<test/bsp_test.cpp>
    ; +<test/motor/gm6020demo.cpp>
    ; +<test/buzzer_test.cpp>
    +<test/motor/M3508demo.cpp>


; 上传协议配置 - 使用简化CMSIS-DAP脚本
upload_protocol = custom
upload_command = python3 ./scripts/cmsis_dap_simple.py .pio/build/cmsis-dap-native/firmware.bin
; 监控过滤器 - 只显示错误和警告信息
monitor_filters = esp32_exception_decoder





[env:void]
; 平台选择: ststm32 - STMicroelectronics STM32系列微控制器平台
platform = ststm32
; 开发板型号: genericSTM32F407IGT6 - 通用STM32F407IGT6开发板
board = genericSTM32F407IGT6
; 框架选择: stm32cube - STM32Cube HAL库框架
framework = stm32cube

; 编译标志配置 - 与DFU环境相同的编译设置
build_flags =
    ; 定义STM32F407系列芯片，用于HAL库的条件编译
    -DSTM32F407xx
    ; 启用HAL驱动库，提供硬件抽象层接口
    -DUSE_HAL_DRIVER
    ; 编译优化级别2，平衡性能和稳定性
    -O2
    ; 指定目标CPU为Cortex-M4内核
    -mcpu=cortex-m4
    ; 指定FPU单元为FPv4-SP-D16(单精度浮点运算单元)
    -mfpu=fpv4-sp-d16
    ; 浮点ABI为硬件浮点，使用FPU进行浮点运算
    -mfloat-abi=hard
    ; 添加头文件搜索路径
    -I include
    -I src/hal
    -I src/bsp
    -I src/drivers/*
    -I src/common/*
    ; 强制使用VFP指令
    -u__printf_float
    -u__scanf_float

    -Wl,--no-warn-mismatch

build_src_filter =
    +<*>
    -<main.cpp>
    -<test/*>
    +<test/void.cpp>


; 上传协议配置 - 使用简化CMSIS-DAP脚本
upload_protocol = custom
upload_command = python3 ./scripts/cmsis_dap_simple.py .pio/build/cmsis-dap-native/firmware.bin
; 监控过滤器 - 只显示错误和警告信息
monitor_filters = esp32_exception_decoder


[env:zyx]
; 平台选择: ststm32 - STMicroelectronics STM32系列微控制器平台
platform = ststm32
; 开发板型号: genericSTM32F407IGT6 - 通用STM32F407IGT6开发板
board = genericSTM32F407IGT6
; 框架选择: stm32cube - STM32Cube HAL库框架
framework = stm32cube

; 编译标志配置 - 与DFU环境相同的编译设置
build_flags =
    ; 定义STM32F407系列芯片，用于HAL库的条件编译
    -DSTM32F407xx
    ; 启用HAL驱动库，提供硬件抽象层接口
    -DUSE_HAL_DRIVER
    ; 编译优化级别2，平衡性能和稳定性
    -O2
    ; 指定目标CPU为Cortex-M4内核
    -mcpu=cortex-m4
    ; 指定FPU单元为FPv4-SP-D16(单精度浮点运算单元)
    -mfpu=fpv4-sp-d16
    ; 浮点ABI为硬件浮点，使用FPU进行浮点运算
    -mfloat-abi=hard
    ; 添加头文件搜索路径
    -I include
    -I src/hal
    -I src/bsp
    -I src/drivers/*
    -I src/common/*
    ; 强制使用VFP指令
    -u__printf_float
    -u__scanf_float

    -Wl,--no-warn-mismatch

build_src_filter =
    +<*>
    -<main.cpp>
    -<test/*>
    ; -<bsp/*>
    +<hal/*>
    +<drivers/*>
    +<common/*>
    ; +<test/bsp_test.cpp>
    ; +<test/M3508demo.cpp>
    +<test/led/simple_led_demo.cpp>


; 上传协议配置 - 直接使用OpenOCD
upload_protocol = custom
upload_command = "C:\\Users\\10705\\.platformio\\packages\\tool-openocd\\bin\\openocd.exe" -f interface/cmsis-dap.cfg -f target/stm32f4x.cfg -c "program .pio/build/zyx/firmware.bin 0x08000000 verify reset exit"
; 监控过滤器 - 只显示错误和警告信息
monitor_filters = esp32_exception_decoder
